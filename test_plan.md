# astrbot_plugin_context_enhancer 测试计划

## 1. 测试环境

- AstrBot 版本: v4.0.0+
- Python 版本: 3.10+
- 测试平台: 群聊环境

## 2. 测试目标

- 验证插件核心功能的正确性。
- 确保所有配置项均按预期工作。
- 检验插件在边界条件下的稳定性和鲁棒性。
- 确认代码重构和修复没有引入新的问题。

## 3. 测试用例

---

### A. 核心功能测试

| 用例 ID | 测试模块 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **A-01** | **上下文注入** | 1. 在群聊中发送几条普通消息。<br>2. @机器人并提出一个需要联系上下文的问题。<br>3. 检查提供给LLM的 `prompt`。 | `prompt` 的开头应包含 `你正在浏览聊天软件...` 的上下文信息，且包含之前的聊天记录。 |
| **A-02** | **机器人回复记录** | 1. @机器人让其回复。<br>2. 再次@机器人并提出问题。<br>3. 检查提供给LLM的 `prompt`。 | `prompt` 的 `你最近的回复:` 部分应包含机器人上一次的回复内容。 |
| **A-03** | **消息分类** | 1. 发送普通消息。<br>2. 发送 `@机器人` 的消息。<br>3. 查看后台日志。 | 日志应能正确区分 `NORMAL_CHAT` 和 `LLM_TRIGGERED` 类型的消息。 |
| **A-04** | **防重复注入** | 1. 在一个已经注入上下文的会话中，继续与机器人对话。<br>2. 检查后续请求的 `prompt`。 | `prompt` 不应重复出现 `你正在浏览聊天软件...` 的上下文信息。 |
| **A-05** | **图片消息处理 (基础)** | 1. 发送一张图片。<br>2. @机器人并提问关于图片的问题。<br>3. 检查 `prompt`。 | `prompt` 中应包含 `[包含1张图片]` 的占位符。 |

---

### B. 配置项测试

| 用例 ID | 测试配置项 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **B-01** | `启用群组` | 1. 设置 `启用群组` 为一个特定的群ID。<br>2. 在该群和另一个未指定的群中分别测试上下文注入。 | 只有在指定群组中，上下文注入才会生效。 |
| **B-02** | `普通消息数量` | 1. 发送15条普通消息。<br>2. 将 `普通消息数量` 设置为 `5`。<br>3. 触发上下文注入并检查 `prompt`。 | `最近的聊天记录:` 部分应只包含最新的 `5` 条普通消息。 |
| **B-03** | `机器人回复数量` | 1. 与机器人进行5次对话。<br>2. 将 `机器人回复数量` 设置为 `2`。<br>3. 再次触发并检查 `prompt`。 | `你最近的回复:` 部分应只包含最新的 `2` 条机器人回复。 |
| **B-04** | `启用图片描述` | 1. 设置 `启用图片描述` 为 `false`。<br>2. 发送图片并提问。<br>3. 检查 `prompt`。 | `prompt` 中应只包含 `[包含1张图片]`，而不包含任何图片描述。 |

---

### C. 边界条件测试

| 用例 ID | 测试场景 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **C-01** | **空消息** | 1. 发送只包含空格或空行的消息。<br>2. 触发上下文注入。 | 插件不应出错，空消息不应被计入有效的上下文。 |
| **C-02** | **长消息** | 1. 发送一条超过500字的长消息。<br>2. 触发上下文注入并检查 `prompt`。 | 插件能正确处理长消息，并将其截断或完整地加入上下文。 |
| **C-03** | **消息轰炸** | 1. 在短时间内快速发送大量消息。<br>2. 触发上下文注入。 | 插件应能正常工作，不会因消息过快而崩溃或丢失记录。防重复机制应能正常工作。 |
| **C-04** | **无历史记录** | 1. 在一个全新的群组或机器人重启后立即触发。 | 插件应能正常处理，不提供任何历史记录，只提供当前请求的信息。 |

---

### D. 兼容性测试

| 用例 ID | 测试场景 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **D-01** | **`utils` 模块缺失** | 1. 临时移除或重命名 `utils` 文件夹。<br>2. 重启 AstrBot。<br>3. 测试核心功能（如A-01）。 | AstrBot 启动时应打印 `utils 模块导入失败` 的警告，但核心的上下文注入功能仍应正常工作。 |
