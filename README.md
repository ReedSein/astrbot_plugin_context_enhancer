# AstrBot 上下文增强器 v2.0 🧠

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![AstrBot](https://img.shields.io/badge/AstrBot-v4.0.0+-green.svg)](https://github.com/Soulter/AstrBot)

一个为 AstrBot 设计的智能上下文增强插件，提供强大的"读空气"功能，让 AI 更好地理解群聊语境和氛围。

## ✨ 特性

### 🎯 核心功能
- **智能上下文增强** - 多维度收集和整理群聊信息
- **"读空气"功能** - 分析群聊氛围、话题和用户互动
- **分层信息架构** - 按重要性和相关性组织上下文信息
- **角色扮演支持** - 完美配合人设系统，不影响 system prompt

### �️ 信息层次结构
1. **当前群聊状态** - 群聊氛围、活跃用户、话题分析
2. **最近群聊内容** - 普通消息背景信息
3. **与你相关的对话** - 触发 AI 回复的重要对话（@提及、唤醒词等）
4. **最近图片信息** - 视觉上下文补充
5. **当前请求详情** - 详细的请求信息和触发方式

### 🔧 技术特点
- **系统安全** - 不覆盖 system_prompt，完全兼容人设系统
- **插件兼容** - 使用合理的优先级，不干扰其他插件
- **高度可配置** - 丰富的配置选项，灵活适应不同需求
- **智能分类** - 自动识别和分类不同类型的消息

## 📦 安装

### 方法一：直接下载
1. 下载本仓库到 AstrBot 的插件目录
```bash
cd /path/to/AstrBot/data/plugins/
git clone https://github.com/muyouzhi6/astrbot_plugin_context_enhancer.git
```

2. 重启 AstrBot

### 方法二：手动安装
1. 在 `data/plugins/` 目录下创建 `astrbot_plugin_context_enhancer` 文件夹
2. 将所有文件复制到该文件夹中
3. 重启 AstrBot

## ⚙️ 配置

插件提供丰富的配置选项，可通过 AstrBot WebUI 或配置文件进行设置：

```json
{
    "enabled_groups": [],              // 启用的群聊ID列表（空=全部群聊）
    "enabled_private": false,          // 是否启用私聊增强
    "bot_self_reference": "你"         // 机器人自称（支持角色扮演）
}
```

### 消息收集配置
```json
{
    "max_triggered_messages": 10,      // 触发消息数量
    "max_normal_messages": 15,         // 普通消息数量
    "max_image_messages": 5,           // 图片消息数量
    "max_bot_replies": 8,              // 机器人回复数量
    "collect_bot_replies": true,       // 是否收集机器人回复
    "ignore_bot_messages": true        // 是否忽略其他机器人消息
}
```

### 显示配置
```json
{
    "detailed_current_request": true,   // 详细的当前请求信息
    "show_interaction_icons": true     // 显示交互图标（👤🤖📷等）
}
```

## 🚀 使用方法

### 自动运行
插件安装后会自动在群聊中工作，无需手动触发。当用户触发 AI 回复时，插件会：

1. **收集上下文** - 从数据库和内存中收集相关消息
2. **智能分析** - 分析群聊氛围和话题走向
3. **结构化整理** - 按层次结构组织信息
4. **增强请求** - 将丰富的上下文信息提供给 LLM

### 效果示例
原始请求：
```
用户：@机器人 今天天气怎么样？
```

增强后的上下文：
```
=== 当前群聊状态 ===
群聊氛围活跃，用户正在讨论天气和出行计划...

=== 最近群聊内容 ===
[13:20] 张三: 明天有雨吗
[13:21] 李四: 我看预报说要下雨
[13:22] 王五: 那明天的活动要取消吗

=== 最近和你相关的对话 ===
👤 [13:18] 张三: @机器人 明天适合户外活动吗？
🤖 [13:19] 你: 根据天气预报，明天有中雨，建议室内活动...

=== 当前需要你回复的请求 ===
📅 详细时间: 2024-01-15 13:25:30
👤 发送者: 用户 (ID: user123)
🎯 触发方式: @提及
💬 请求内容: 今天天气怎么样？
```

## 🎭 角色扮演支持

插件完美支持角色扮演，通过 `bot_self_reference` 配置：

```json
{
    "bot_self_reference": "小猫咪"  // 机器人会以"小猫咪"自称
}
```

效果：
```
=== 最近和小猫咪相关的对话 ===
👤 [13:18] 主人: @小猫咪 你好吗？
🤖 [13:19] 小猫咪: 喵～小猫咪很好呢！
```

## 🔍 调试和监控

插件提供详细的日志输出，方便调试：

```
[13:22:42] Context Enhancer接收到LLM请求:
  - prompt长度: 15
  - system_prompt长度: 234
  - contexts数量: 8
[13:22:42] 上下文增强完成，新prompt长度: 1247
[13:22:42] System prompt保持不变，长度: 234
```

## 🛠️ 技术实现

### 架构设计
- **消息监听** - 通过 `@filter.on_message` 监听所有消息
- **智能分类** - 自动识别触发消息、普通消息、图片消息
- **LLM拦截** - 通过 `@filter.on_llm_request` 拦截并增强请求
- **安全处理** - 使用 `priority=100` 确保兼容性

### 数据流程
```
消息接收 → 分类存储 → LLM请求拦截 → 上下文收集 → 智能分析 → 结构化组织 → 增强输出
```

### 兼容性保证
- ✅ 不影响 `system_prompt`（人设、时间戳等系统信息）
- ✅ 不干扰其他插件的 prompt 修改
- ✅ 支持多平台（QQ、Telegram、Discord 等）
- ✅ 向后兼容 AstrBot v4.0+

## 📊 性能优化

- **内存管理** - 使用 `deque` 限制消息缓存大小
- **数据库优化** - 智能查询，避免不必要的数据库访问
- **异步处理** - 所有操作均为异步，不阻塞主流程
- **错误处理** - 完善的异常处理，不影响系统稳定性

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 开发指南
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 📄 许可证

本项目基于 MIT 许可证开源 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 👨‍💻 作者

**木有知** - [GitHub](https://github.com/muyouzhi6)

## 🙏 致谢

- [AstrBot](https://github.com/Soulter/AstrBot) - 优秀的多平台聊天机器人框架
- [SpectreCore](https://github.com/23q3) - 灵感来源

## 📚 相关项目

- [AstrBot](https://github.com/Soulter/AstrBot) - 主框架
- [AstrBot 插件生态](https://github.com/Soulter/AstrBot/wiki/插件开发) - 更多插件

## 🔗 链接

- [AstrBot 官方文档](https://astrbot.soulter.top/)
- [插件开发指南](https://astrbot.soulter.top/develop/)
- [问题反馈](https://github.com/muyouzhi6/astrbot_plugin_context_enhancer/issues)

---

⭐ 如果这个插件对你有帮助，请给个 Star！

### 🔌 插件兼容性
- ✅ **低优先级Hook**：使用 `priority=100` 避免干扰其他插件
- ✅ **安全模式**：出错时不影响正常LLM流程
- ✅ **非侵入性**：只增强上下文，不改变其他插件行为

### 🎯 智能消息分类
- ✅ **多重判断机制**：@机器人、命令前缀、唤醒状态、触发词
- ✅ **避免误分类**：短消息和常见词汇不误判为触发消息
- ✅ **平台兼容**：支持不同平台的消息格式

## 🔧 工作原理

### 1. 消息收集阶段
- 监听所有群聊消息（`@filter.platform_adapter_type`）
- 智能分类消息类型：
  - **触发类消息**: 包含@、命令前缀等
  - **普通聊天**: 日常交流消息
  - **图片消息**: 包含图像的消息

### 2. 上下文增强阶段
- 在LLM请求时被触发（`@filter.on_llm_request(priority=1)`）
- 从消息缓存中收集各类消息
- 分析群聊氛围和活跃用户
- 构建结构化的上下文信息

### 3. Prompt重构
- 将原始用户输入包装在丰富的上下文中
- 指导LLM基于群聊情况做出更贴切的回应

## 📈 应用场景

### 场景1：话题理解
```
用户A: 刚才说的那个地方在哪？
AI: [基于群聊上下文] 你是指张三提到的那个公园吗？根据刚才的讨论...
```

### 场景2：氛围感知
```
群聊氛围: 大家在讨论周末计划
用户B: @机器人 推荐个活动
AI: [感知到大家在讨论户外活动] 看到大家都想出门，推荐几个适合团体的户外活动...
```

### 场景3：图像关联
```
用户C发了张图片 → 群里讨论了几句 → 用户D: @机器人 这个怎么样
AI: [结合图片和讨论内容] 关于张三刚才分享的那张风景照...
```

## 🔄 与原生AstrBot的区别

| 方面 | 原生AstrBot | 智能增强器v2.0 |
|------|-------------|----------------|
| 消息感知 | 仅触发时的当前消息 | 全方位群聊消息收集 |
| 上下文范围 | 正式对话历史 | 对话历史+群聊氛围+图片信息 |
| 氛围理解 | 无 | 分析活跃用户和话题 |
| 图片处理 | 单独处理 | 融入时间线上下文 |
| 工作模式 | 被动响应 | 主动感知+被动增强 |

## 🎭 "读空气"能力详解

这个插件的核心价值在于让AI具备真正的"空气感知"能力：

1. **时间感知**: 理解消息的时间顺序和发展脉络
2. **人际感知**: 知道谁在说话，谁在互动
3. **话题感知**: 了解群聊的讨论主题和走向
4. **情境感知**: 结合图片、表情等多媒体信息
5. **氛围感知**: 判断群聊是活跃、平静还是在讨论特定话题

## 💡 最佳实践

1. **群组配置**: 对于活跃群组，可以适当增加消息收集数量
2. **话题群优化**: 对于特定话题群，关注图片消息的比例
3. **性能平衡**: 根据群活跃度调整缓存大小避免内存占用过大
4. **隐私保护**: 注意敏感群组的配置，可在`enabled_groups`中精确控制

## 🔒 隐私说明

- 插件仅在内存中临时缓存消息，不持久化存储
- 消息缓存有数量限制，自动清理旧消息
- 只在配置允许的群组和私聊中工作
- 不会主动发送消息，仅提供上下文增强

---

通过这个智能上下文增强器，你的AI助手将具备真正的"读空气"能力，能够理解群聊的真实情况，提供更自然、更贴切的回应。
