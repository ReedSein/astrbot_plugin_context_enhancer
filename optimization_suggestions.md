# astrbot_plugin_context_enhancer 优化建议

基于对 v2.0 代码的深入分析和重构，我提出以下几点优化建议，旨在进一步提升插件的健壮性、可维护性和用户体验。

### 1. 配置键名统一 (P0 - 已完成)

- **问题**: `config.json` 使用英文键名，而代码逻辑和 `_conf_schema.json` 使用中文键名，导致配置文件完全失效。
- **建议**: 将 `config.json` 的键名统一为中文。
- **状态**: **已在本次调研中修复。**

### 2. 代码与文档一致性 (P1 - 已完成)

- **问题**:
    1.  `main.py` 中存在 `_build_structured_context` 等 v1.x 版本的残留代码，与 v2.0 的简洁设计不符。
    2.  `ContextEnhancerV2` 类的文档字符串（docstring）仍在描述已废弃的分层架构。
- **建议**:
    1.  删除或注释掉未使用的旧方法。
    2.  更新文档字符串，使其准确反映 v2.0 的功能。
- **状态**: **已在本次调研中修复。**

### 3. 提升配置加载的健壮性 (P2 - 建议)

- **现状**: `load_config` 方法在加载失败时会直接回退到 `get_default_config`。这虽然保证了插件的运行，但用户可能不会察觉到自己的配置文件出了问题（比如JSON格式错误）。
- **建议**: 在 `load_config` 的 `except` 块中，增加一个更明显的 `logger.error` 或 `logger.warning`，明确提示用户“配置文件解析失败，请检查 config.json 文件格式是否正确”。这样能帮助用户更快地定位问题。

### 4. 优化消息去重逻辑 (P2 - 建议)

- **现状**: `_is_duplicate_message` 方法通过检查最近5条消息的发送者、内容和时间戳来去重。
- **建议**:
    - **增加消息ID比对**: 许多平台（如 QQ、Discord）的消息事件会提供唯一的消息ID (`message_id`)。可以优先使用 `message_id` 进行精确去重，这比内容比对更可靠、性能也更好。
    - **考虑异步延迟**: 在某些情况下，事件可能会因网络延迟而重复到达。将时间窗口 `30秒` 作为一个可配置的选项，可能会让插件在不同网络环境下表现更好。

### 5. 引入异步锁 (Async Lock) (P3 - 建议)

- **现状**: 多个异步事件（如 `on_message`, `on_llm_request`）可能会并发地访问和修改同一个群组的消息缓冲区 `self.group_messages[group_id]`。虽然 `deque` 本身是线程安全的，但在复杂的异步操作（如先检查后添加）中，仍存在理论上的竞态条件风险。
- **建议**: 为每个群组的消息缓冲区创建一个 `asyncio.Lock`。在任何需要修改缓冲区的代码块（如 `_get_group_buffer` 中的添加操作，或 `_mark_current_as_llm_triggered` 中的修改操作）前后，使用 `async with self.group_locks[group_id]:` 来确保数据一致性。

### 6. 统一的常量管理 (P3 - 建议)

- **现状**: `ContextConstants` 类很好地管理了一部分常量。但 `config.json` 中的默认值是直接写在 `get_default_config` 方法中的。
- **建议**: 可以在 `ContextConstants` 类中也定义默认配置的常量，然后在 `get_default_config` 中引用这些常量。这样做可以使所有常量都集中在一个地方，更便于管理和查阅。

---
**优先级说明:**
- **P0**: 阻塞性问题，必须修复。
- **P1**: 高优先级，严重影响代码质量和可读性。
- **P2**: 中优先级，能明显改善用户体验和插件健壮性。
- **P3**: 低优先级，代码层面的微小优化，可以进一步提升代码质量。